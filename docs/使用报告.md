# NovelAgent 使用报告

本文档为项目**使用说明与操作速查**，涵盖分析、续写、用户偏好、自我改良及调试方式。

---

## 一、项目概述

NovelAgent 实现「分析 → 续写/改写」的网文生成与优化闭环，主要能力包括：

- **分析**：智能采样 + 元协议 + 滑动窗口提取 → 因果链、知识卡片、冲突标记（存于 `data/cards`）
- **续写/改写**：基于三维上下文（历史因果、新锚点、规则约束）+ 用户意图，分层生成（战略→逻辑→草稿→润色），支持 3 走向选择与用户偏好注入
- **用户心理**：用户偏好协议、意图解析、满意度反馈、类似体验推荐
- **自我改良**：续写 → Simulator 评分 → 低分则工程诊断并自动改码 → 循环直到达标，达标自动快照

---

## 二、环境与依赖

### 2.1 安装

```bash
cd NovelAgent
pip install -r requirements.txt
```

### 2.2 环境变量（.env）

| 变量 | 说明 | 示例 |
|------|------|------|
| DEEPSEEK_API_KEY | DeepSeek API Key（推荐） | sk-... |
| ANALYZER_HIGH_MODEL | 高质量模型（协议/逻辑/批判/诊断） | deepseek-reasoner |
| ANALYZER_LOW_MODEL | 低成本模型（批量提取/草稿） | deepseek-chat |

详见 `docs/model_recommendations.md` 与 `.env.example`。

---

## 三、命令速查

所有命令均在**项目根目录**执行：`python main.py <子命令> [选项]`。

### 3.1 分析 (analyze)

| 用法 | 说明 |
|------|------|
| `python main.py analyze --book-id 7320218217488600126` | 对全书做采样 + 元协议 + 提取 + 整合 |
| `python main.py analyze --book-id 7320218217488600126 --chapters 30` | 只分析前 30 章 |

输出：`data/cards/{book_id}/analysis_state.json`。续写、改写、evolve 均依赖该文件。

### 3.2 逻辑回溯 (backtrack)

写作前检查「某剧情是否与既有设定矛盾」：

```bash
python main.py backtrack --book-id 7320218217488600126 --action "张三在此时杀掉李四" [--chapter 5]
```

### 3.3 改写评估 (rewrite)

评估「改写第 N 章」的影响并构建三维上下文（可选双重校对）：

```bash
python main.py rewrite --book-id 7320218217488600126 --chapter 10 --anchors "主角发现密信后选择隐瞒"
# 若有续写稿可做逻辑+风格校对
python main.py rewrite --book-id 7320218217488600126 --chapter 10 --anchors "..." --draft "（续写正文）"
```

### 3.4 续写/改写生成 (write)

| 用法 | 说明 |
|------|------|
| `python main.py write --book-id 7320218217488600126 --chapter 10 --intent "主角潜入敌营发现密信"` | 生成第 11 章续写（默认走向 0） |
| `python main.py write --book-id 7320218217488600126 --chapter 10 --intent "..." --branch 1 --out ch11.txt` | 选第 2 个走向并保存到文件 |
| `python main.py write --book-id 7320218217488600126 --chapter 10 --intent "..." --preview-only` | 只输出 3 个走向摘要，不生成正文 |

若存在 `data/user_center/{book_id}_preference.json`，会自动注入用户偏好补丁。

### 3.5 整书流水线 (full-pipeline)

一键跑「分析 → 知识库 → 仿写」或仅仿写阶段，支持**逆向重构**与**多打字机并行渲染**。

| 用法 | 说明 |
|------|------|
| `python main.py full-pipeline --book-id 7598852570919996440` | 分析 + 写库 + 按框架逐章仿写（默认非重构） |
| `python main.py full-pipeline --book-id xxx --reconstruction` | **逆向重构**：从知识库情节树做逻辑适配 → 渲染 → 后台入库 |
| `python main.py full-pipeline --book-id xxx --reconstruction --skip-analyze` | 使用已有知识库，跳过分析，只跑 Phase 1 搭框架 + Phase 2 渲染 |
| `python main.py full-pipeline --book-id xxx --reconstruction --skip-analyze --skip-framework` | **直接使用已有框架**：跳过 Phase 1，仅用已有 `reconstructed_outline.json` 做 Phase 2 |
| `python main.py full-pipeline --book-id xxx --reconstruction --skip-analyze --skip-framework --concurrent` | 同上，且 Phase 2 使用**多打字机并行渲染** + 后台入库 |
| `python main.py full-pipeline --book-id xxx --reconstruction --concurrent --render-workers 4` | 并行渲染时指定 worker 数（默认 3） |

输出：仿写正文与知识入库在 `data/cards/{book_id}/` 下；重构大纲为 `reconstructed_outline.json`。

### 3.6 用户偏好 (user-profile)

生成用户偏好协议，供 write 时注入：

```bash
python main.py user-profile --book-id 7320218217488600126 --prompt "我喜欢快节奏、绝境反杀，不喜欢压抑不爆发"
```

输出：`data/user_center/{book_id}_preference.json`。

### 3.7 自我改良优化 (evolve)

续写 → 评分 → 不合格则诊断并自动改码 → 再跑，直到达标或达最大迭代；达标时自动打快照：

```bash
python main.py evolve --book-id 7320218217488600126 --chapter 0 --threshold 85 --max-iter 10
```

- `--chapter`：测试章节索引（0-based）
- `--threshold`：达标分数（三维平均），默认 85
- `--max-iter`：最大迭代次数，默认 10

详见 `docs/evolution_optimize.md`。

---

## 四、目录与数据流

```
NovelAgent/
├── data/
│   ├── raw/{book_id}/          # 原始书籍数据：{book_id}.json, novel_catalog.json
│   ├── cards/{book_id}/        # 分析结果：analysis_state.json, novel_database.json, style_fingerprint.json；仿写：reconstructed_outline.json
│   ├── user_center/            # 用户偏好：{book_id}_preference.json
│   └── logs/                   # 执行 trace：execution_trace.jsonl（可选）
├── backend/engine/             # 仿写引擎：逻辑适配、框架构建、多打字机并行渲染（run_imitation_test, auto_novel_engine）
├── snapshots/                  # evolve 达标时的代码快照 zip
├── langgraph.json              # LangGraph Studio 图入口
├── langgraph_app/writer.py     # 写作图暴露给 Studio
├── src/
│   ├── analyzer/               # 分析流水线、因果、改写评估
│   ├── librarian/              # 风格库、三维上下文
│   ├── writer/                 # 分层生成、LangGraph、检测
│   ├── user_center/            # 用户心理、意图、满意度、推荐
│   ├── evolution/              # Trace、Simulator、诊断、快照、主控、改码
│   └── utils/                  # LLM 客户端、日志
├── tests/run_full_test.py      # 完整测试（Phase1 无 API + Phase2 有 API）
└── docs/                       # 使用报告、模型推荐、Studio、evolution 说明
```

---

## 五、推荐使用流程

1. **分析**：`analyze --book-id xxx --chapters 30`（或全书）
2. **（可选）用户偏好**：`user-profile --book-id xxx --prompt "我喜欢..."`
3. **续写**：`write --book-id xxx --chapter 9 --intent "续写下一章" [--out ch10_draft.txt]`
4. **（可选）自我改良**：`evolve --book-id xxx --chapter 0 --threshold 85 --max-iter 10`

**仿写整书（逆向重构）**：在已有分析结果的前提下，可直接用已有框架做并行渲染，或先搭框架再渲染：

- 使用已有大纲、只跑 Phase 2 并行渲染：  
  `full-pipeline --book-id xxx --reconstruction --skip-analyze --skip-framework --concurrent`
- 先搭框架再渲染（不重跑分析）：  
  `full-pipeline --book-id xxx --reconstruction --skip-analyze --concurrent`

调试写作图状态可配合：

- **自写检测**：`python -m src.writer.graph_inspect --book-id xxx --chapter 0`（逐节点打印）
- **LangGraph Studio**：`pip install "langgraph-cli[inmem]"` 后 `langgraph dev`，在浏览器中看图与状态（见 `docs/langgraph_studio.md`）

---

## 六、测试

```bash
python tests/run_full_test.py
```

- 无 API Key：仅跑 Phase 1（导入、Trace、评分、file_operator、StyleStore、意图解析、快照等）。
- 有 `.env` 中的 DEEPSEEK_API_KEY：会再跑 Phase 2（analyze 2 章 + write preview 3 走向）。

---

## 七、相关文档

| 文档 | 内容 |
|------|------|
| `docs/model_recommendations.md` | 各模块模型安排与推荐配置 |
| `docs/分析模块技术报告.md` | 分析模块架构、双环流水线、模型与配置 |
| `docs/evolution_optimize.md` | 自我改良模块组成与入口 |
| `docs/langgraph_studio.md` | LangGraph Studio 本地可视化调试 |
| `.env.example` | 环境变量示例与注释 |

以上为 NovelAgent 使用报告，按需查阅对应小节与文档即可。
